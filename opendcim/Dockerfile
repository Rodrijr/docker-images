# openDCIM Dockerfile

FROM debian:jessie
MAINTAINER Karol Kozubal <karol.kozubal@oriaks.com>

COPY nonfree.list /etc/apt/sources.list.d/nonfree.list

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update -qy && \
    apt-get install -qy \
    apache2 \
    bsdtar \
    ca-certificates \
    curl \
    graphviz \
    locales \
    php5 \
    php5-curl \
    php-gettext \
    php5-mysql \
    php5-snmp \
    snmp-mibs-downloader \
    sed \
    ssl-cert

# Fixing locale data, openDCIM uses this for setting the app language
RUN echo "en_US.UTF-8 UTF-8" > /etc/locale.gen && \
    locale-gen en_US.UTF-8 && \
    dpkg-reconfigure locales && \
    /usr/sbin/update-locale LANG=en_US.UTF-8
ENV LC_ALL en_US.UTF-8

# cleanup + remove certs so they get regenerated by docker-entrypoint.sh
RUN apt-get autoremove -qy --purge && \
    apt-get clean -qy && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    rm -f /etc/ssl/certs/ssl-cert-snakeoil.pem /etc/ssl/private/ssl-cert-snakeoil.key

RUN mkdir /opt/www && \
    curl http://opendcim.org/packages/openDCIM-4.3.1.tar.gz | bsdtar -xf- -C /opt/www && \
    mv /opt/www/openDCIM-4.3.1 /opt/www/opendcim

RUN chgrp -R www-data /opt/www/opendcim/pictures /opt/www/opendcim/drawings

COPY db.inc.php /opt/www/opendcim/db.inc.php 
COPY default-ssl.conf /etc/apache2/sites-available/default-ssl.conf
COPY default-ssl.conf.ldap /etc/apache2/sites-available/default-ssl.conf.ldap
COPY htaccess /opt/www/opendcim/.htaccess

RUN htpasswd -cb /opt/www/opendcim.password dcim dcim

VOLUME /opt/www

RUN a2enmod ssl && \
    a2enmod rewrite && \
    a2ensite default-ssl
 
ENV DCIM_MYSQL_HOST mysql 
ENV DCIM_DBNAME opendcim
ENV DCIM_DBUSER opendcim
ENV DCIM_DBPASS opendcim

# Specify if openDCIM should use LDAP Authentication
ENV AUTHLDAP no

# Apache LDAP AUth Config default values
# overwrite values in docker-compose or with docker run -e
ENV AUTHLDAPURL="AuthLDAPURL ldaps://ldap.example.org/dc=example,dc=org"
ENV AUTHLDAPBINDDN="AuthLDAPBindDN uid=intranet,ou=applications,dc=example,dc=org"
ENV AUTHLDAPBINDPASSWORD="AuthLDAPBindPassword ldappassword"
ENV REQUIRE="Require ldap-group cn=example,ou=groups,dc=example,dc=org"

COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

EXPOSE 443
VOLUME /opt/www

ENTRYPOINT [ "/docker-entrypoint.sh" ]
CMD [ "apache2" ]
